<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Produtos FakeStore</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-light">

  <div class="container my-5">
    <h1 class="mb-4">Produtos da FakeStore API</h1>

    <div class="d-flex justify-content-between mb-3">
      <input type="text" id="searchInput" class="form-control w-50 me-2" placeholder="Buscar produto por título...">
      <button class="btn btn-danger" id="btn-pdf">Gerar PDF</button>
    </div>

    <div id="tabela-produtos">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Preço</th>
            <th>Categoria</th>
            <th>Imagem</th>
            <th>Quantidade</th>
            <th>Desconto</th>
            <th>Valor Total com Desconto</th>
          </tr>
        </thead>
        <tbody id="products-table-body"></tbody>
        <tfoot class="table-secondary">
          <tr>
            <td colspan="7" class="text-end fw-bold">Soma Total com Desconto:</td>
            <td id="soma-total" class="fw-bold">$0.00</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    let produtos = [];

    const fetchProdutos = async () => {
      try {
        const response = await fetch('https://fakestoreapi.com/products');
        const data = await response.json();
        produtos = data;
        renderTabela(produtos);
      } catch (error) {
        console.error('Erro ao buscar os produtos:', error);
      }
    };

    const renderTabela = (produtosFiltrados) => {
      const tableBody = document.getElementById('products-table-body');
      const somaTotalCell = document.getElementById('soma-total');
      const desconto = 0.10;
      let somaTotalComDesconto = 0;

      tableBody.innerHTML = '';

      produtosFiltrados.forEach(product => {
        const quantidade = product.rating.count; // puxando o count da avaliação como quantidade
        const valorTotal = product.price * quantidade;
        const valorComDesconto = valorTotal * (1 - desconto);
        somaTotalComDesconto += valorComDesconto;

        const row = `
          <tr>
            <td>${product.id}</td>
            <td>${product.title}</td>
            <td>$${product.price.toFixed(2)}</td>
            <td>${product.category}</td>
            <td><img src="${product.image}" alt="Imagem do Produto" height="50"></td>
            <td>${quantidade}</td>
            <td>${(desconto * 100).toFixed(0)}%</td>
            <td>$${valorComDesconto.toFixed(2)}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });

      somaTotalCell.textContent = `$${somaTotalComDesconto.toFixed(2)}`;
    };

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const termo = e.target.value.toLowerCase();
      const filtrados = produtos.filter(p => p.title.toLowerCase().includes(termo));
      renderTabela(filtrados);
    });

    document.getElementById('btn-pdf').addEventListener('click', () => {
      const tabela = document.getElementById('tabela-produtos');
      const opt = {
        margin:       0.5,
        filename:     'produtos_fakestore.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
      };
      html2pdf().from(tabela).set(opt).save();
    });

    fetchProdutos();
  </script>

</body>
</html>
